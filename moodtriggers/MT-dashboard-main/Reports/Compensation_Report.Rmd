---
title: "Compensation Report"

output:
  word_document:
    reference_docx: "template_comp.docx"
  html_document: default
  pdf_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
library(dplyr)
library(kableExtra)
library(RPostgres)

library(DBI)
library(RSQLite)

###########

# participant_number <- params$participant_number
# google_takeout <- params$google_takeout

participant_number <-Sys.getenv("PARTICIPANT_NUMBER", NA)
google_takeout <- Sys.getenv("GOOGLE_TAKEOUT", "FALSE") == "TRUE"

################
knitr::opts_chunk$set(echo = TRUE)



# Read environment variables (with defaults)
DB_USER <- Sys.getenv("DB_USER", "hannah")
DB_PASSWORD <- Sys.getenv("DB_PASSWORD", "moodtriggers2025")
DB_HOST <- Sys.getenv("DB_HOST", "localhost")
DB_PORT <- Sys.getenv("DB_PORT", "5432")
DB_NAME <- Sys.getenv("DB_NAME", "moodtriggers")

# Connect to PostgreSQL database
con <- dbConnect(
  RPostgres::Postgres(),
  user = DB_USER,
  password = DB_PASSWORD,
  host = DB_HOST,
  port = DB_PORT,
  dbname = DB_NAME
)

# Load tables
Weekly <- dbReadTable(con, "weekly_data")
poststudy <- dbReadTable(con, "post_assessment")


# Parameterized query
query <- "
  SELECT participant_id, 
         total_EMA
    FROM overall_status_cache
   WHERE participant_id = $1 OR participant_id = CONCAT('-', $1)
"

# Execute query and fetch results as a data frame
EMA_completed <- dbGetQuery(con, query, params = list(participant_number))

query <- "
  SELECT participant_id, 
         overall_compliance
    FROM overall_status_cache
   WHERE participant_id = $1 OR participant_id = CONCAT('-', $1)
"

# Execute query and fetch results as a data frame
EMA_overall <- dbGetQuery(con, query, params = list(participant_number))

# (Optional) Filter by participant if needed
# EMA <- subset(EMA, participant_id == participant_number)

# Disconnect when done
dbDisconnect(con)

# # Initial Diagnostic Interview: all
# # Baseline Assessment: all
# EMA$Total_Questionnaires[EMA$participant_number == participant_number] #Ecological Momentary Assessment (EMA_compliance.csv)
# nrow(Weekly[Weekly$record_id == participant_number,]) # Weekly Assessment (weekly_raw__data.csv)
# poststudy$p_complete[poststudy$record_id == participant_number] == 2 # Post-study Survey
# EMA$Overall.Percentage[EMA$participant_number == participant_number] > 90 # 90% Compliance Bonu
# google_takeout #Google Takeout Upload
```

# Thank you!

Below is a summary of your participation rate and a breakdown of your
compensation. Your involvement was a great help to our research, and we
truly appreciate your time and effort. We may contact you in the future
for a follow-up study.
 \newline

```{r compensation-table, echo=FALSE, message=FALSE, warning=FALSE}
library(flextable)

# Load datasets


EMA_completed <- sum(EMA_completed$total_ema, na.rm = TRUE)

EMA_target <- 270

weekly_completed <- nrow(Weekly[Weekly$record_id == participant_number,])
weekly_target <- 12

poststudy_completed <- ifelse(any(poststudy$p_complete[poststudy$record_id == as.integer(participant_number)] == 2), TRUE, FALSE)

compliance_met <- any(EMA_overall$overall_compliance > 89, na.rm = TRUE)

# Calculate compensation
comp_initial <- 40
comp_baseline <- 20
comp_ema <- 1 * EMA_completed
comp_weekly <- 1 * weekly_completed
comp_poststudy <- ifelse(poststudy_completed, 40, 0)
comp_bonus <- ifelse(compliance_met[1], 30, 0)
comp_google <- ifelse(google_takeout, 10, 0)

total_comp <- comp_initial + comp_baseline + comp_ema + comp_weekly + comp_poststudy + comp_bonus + comp_google

# Create summary table with clean header names
compensation_table <- data.frame(
  "Study Component" = c(
    "Initial Diagnostic Interview", 
    "Baseline Assessment", 
    "Ecological Momentary Assessment", 
    "Weekly Assessment", 
    "Post-study Survey", 
    "90% Compliance Bonus (if eligible)", 
    "Google Takeout Upload", 
    "Total Compensation"
  ),
  "Compensation Per Unit" = c(
    "$40", "$20", "$1", "$1", "$40", "$30", "$10", ""
  ),
  Completed = c(
    "Yes", 
    "Yes", 
    paste0(EMA_completed, "/", EMA_target), 
    paste0(weekly_completed, "/", weekly_target), 
    ifelse(poststudy_completed, "Yes", "No"),
    ifelse(compliance_met, "Yes", "No"),
    ifelse(google_takeout, "Yes", "No"),
    ""
  ),
  Compensation = c(
    paste0("$", comp_initial), 
    paste0("$", comp_baseline), 
    paste0("$", comp_ema), 
    paste0("$", comp_weekly), 
    paste0("$", comp_poststudy), 
    paste0("$", comp_bonus), 
    paste0("$", comp_google), 
    paste0("$", total_comp)
  )
)

colnames(compensation_table) <- c("Study Component", "Compensation Per Unit", "Completed", "Compensation")
# Build flextable
comp_table <- flextable(compensation_table)

# Bold the last row (Total Compensation)
comp_table <- bold(comp_table, i = nrow(compensation_table), bold = TRUE, part = "body")

# Optional: Adjust column widths
comp_table <- autofit(comp_table)

comp_table
```

\newline


Compensation is prorated based on participation and completed parts.
**Thank you again for your dedication and hard work!**

\newline
Best,

The Sensing Schizophrenia Study Team
