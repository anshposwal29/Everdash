{% extends "base.html" %}

{% block title %}Dashboard - Theradash{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Therabot Conversation Dashboard</h1>

    <div class="dashboard-controls">
        <div class="filter-controls">
            <form method="GET" action="{{ url_for('dashboard') }}" class="filter-form">
                <div class="form-inline">
                    {% if projects|length > 1 %}
                    <label for="project_filter">Study:</label>
                    <select id="project_filter" name="project" onchange="this.form.submit()">
                        <option value="all">All Studies</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if project_filter == project.id %}selected{% endif %}>
                            {{ project.name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% endif %}

                    {% if research_assistants|length > 0 %}
                    <label for="ra_filter">RA:</label>
                    <select id="ra_filter" name="ra" onchange="this.form.submit()">
                        <option value="all">All RAs</option>
                        {% for ra in research_assistants %}
                        <option value="{{ ra }}" {% if ra_filter == ra %}selected{% endif %}>
                            {{ ra }}
                        </option>
                        {% endfor %}
                    </select>
                    {% endif %}

                    <label for="risk_filter">Risk:</label>
                    <select id="risk_filter" name="risk" onchange="this.form.submit()">
                        <option value="all" {% if risk_filter == 'all' %}selected{% endif %}>All Users</option>
                        <option value="risky" {% if risk_filter == 'risky' %}selected{% endif %}>High Risk Only</option>
                        <option value="not_risky" {% if risk_filter == 'not_risky' %}selected{% endif %}>No Risk</option>
                    </select>

                    <label for="start_date">Start Date:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date.isoformat() }}" required>

                    <label for="end_date">End Date:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date.isoformat() }}" required>

                    <button type="submit" class="btn btn-secondary">Update</button>
                </div>
            </form>
        </div>

        <div class="sync-controls">
            <button id="sync-btn" class="btn btn-primary">
                <span class="sync-icon">&#x21bb;</span> Refresh Data
            </button>
            {% if last_sync %}
            <small class="sync-status">
                Last sync: {{ last_sync.created_at.strftime('%Y-%m-%d %I:%M %p') }}
                ({{ last_sync.messages_synced }} messages)
            </small>
            {% else %}
            <small class="sync-status">No sync yet</small>
            {% endif %}
        </div>
    </div>
</div>

<div class="dashboard-info">
    <div class="info-box">
        <strong>Total Users:</strong> {{ dashboard_data|length }}
    </div>
    <div class="info-box">
        <strong>Date Range:</strong> {{ start_date.strftime('%b %d, %Y') }} - {{ end_date.strftime('%b %d, %Y') }}
    </div>
    <div class="info-box alert-info">
        <span class="risk-indicator high">Risky</span> = Red highlight
    </div>
</div>

<div class="dashboard-grid-container">
    <table class="dashboard-grid">
        <thead>
            <tr>
                <th class="sticky-col info-panel-header">User Info</th>
                {% for date in date_range %}
                <th class="date-col">
                    <div class="date-header">
                        <div class="day-name">{{ date.strftime('%a') }}</div>
                        <div class="date-number">{{ date.strftime('%m/%d') }}</div>
                    </div>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for user_row in dashboard_data %}
            <tr>
                <td class="sticky-col info-panel-cell">
                    <a href="{{ url_for('user_detail', firebase_id=user_row.firebase_id, start_date=start_date.isoformat(), end_date=end_date.isoformat()) }}" class="info-panel-link">
                        <div class="info-panel">
                            <div class="info-row info-primary">
                                <span class="info-id" title="REDCap: {{ user_row.redcap_id }}">{{ user_row.redcap_id }}</span>
                                {% if user_row.identifier and user_row.identifier != user_row.redcap_id %}
                                <span class="info-identifier">{{ user_row.identifier }}</span>
                                {% endif %}
                            </div>
                            <div class="info-row info-secondary">
                                {% if user_row.research_assistant %}
                                <span class="info-tag info-ra" title="RA">{{ user_row.research_assistant }}</span>
                                {% endif %}
                                {% if projects|length > 1 and user_row.project_name %}
                                <span class="info-tag info-project" title="{{ user_row.project_name }}">{{ user_row.project_name[:10] }}{% if user_row.project_name|length > 10 %}..{% endif %}</span>
                                {% endif %}
                            </div>
                            {% if user_row.dropped or user_row.dropped_surveys %}
                            <div class="info-row info-dropped">
                                {% if user_row.dropped %}
                                <span class="info-tag info-dropped-app" title="Dropped from app">Dropped App</span>
                                {% endif %}
                                {% if user_row.dropped_surveys %}
                                <span class="info-tag info-dropped-surveys" title="Dropped from surveys">Dropped Surveys</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if user_row.study_start_date or user_row.study_end_date %}
                            <div class="info-row info-dates">
                                <span class="info-date-range" title="Study period">{{ user_row.study_start_date or '?' }} - {{ user_row.study_end_date or '?' }}</span>
                            </div>
                            {% endif %}
                            {% if custom_field_labels %}
                            <div class="info-row info-custom">
                                {% for label in custom_field_labels %}
                                {% set field_value = user_row.custom_fields.get(label, '') %}
                                {% if field_value %}
                                <span class="info-tag info-custom-field" title="{{ label }}: {{ field_value }}">{{ field_value[:8] }}{% if field_value|length > 8 %}..{% endif %}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </a>
                </td>
                {% for date in date_range %}
                {% set date_key = date.isoformat() %}
                {% set cell_data = user_row.dates.get(date_key, {'count': 0, 'has_risky': False, 'has_unreviewed': False}) %}
                <td class="message-cell {% if cell_data.has_risky %}high-risk{% elif cell_data.count > 0 %}has-messages{% endif %} {% if cell_data.has_unreviewed %}unreviewed{% endif %}"
                    data-count="{{ cell_data.count }}"
                    data-firebase-id="{{ user_row.firebase_id }}"
                    data-date="{{ date_key }}"
                    onclick="{% if cell_data.count > 0 %}showMessages('{{ user_row.firebase_id }}', '{{ date_key }}'){% endif %}"
                    style="{% if cell_data.count > 0 %}cursor: pointer;{% endif %}"
                    title="{% if cell_data.has_risky %}RISKY MESSAGE! {% endif %}{{ cell_data.count }} message(s){% if cell_data.has_unreviewed %} - UNREVIEWED{% endif %}">
                    {% if cell_data.count > 0 %}
                        <span class="message-count">{{ cell_data.count }}</span>
                        {% if cell_data.has_risky %}
                        <span class="risk-badge">!</span>
                        {% endif %}
                        {% if cell_data.has_unreviewed %}
                        <span class="unreviewed-badge">⚠</span>
                        {% endif %}
                    {% else %}
                        <span class="no-messages">-</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="sync-status-message" class="status-message" style="display: none;"></div>

<!-- Message Modal -->
<div id="message-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Messages</h2>
            <span class="close" onclick="closeMessageModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="message-modal-info"></div>
            <div id="message-modal-messages"></div>
        </div>
        <div class="modal-footer">
            <button id="mark-reviewed-btn" class="btn btn-primary" onclick="markDateReviewed()">
                Mark All as Reviewed
            </button>
            <button class="btn btn-secondary" onclick="closeMessageModal()">Close</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('sync-btn').addEventListener('click', function() {
    const btn = this;
    const statusMessage = document.getElementById('sync-status-message');

    // Disable button and show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="sync-icon spinning">&#x21bb;</span> Syncing...';
    statusMessage.style.display = 'block';
    statusMessage.className = 'status-message info';
    statusMessage.textContent = 'Syncing data from Firebase...';

    // Make API call
    fetch('/api/sync', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusMessage.className = 'status-message success';
            statusMessage.textContent = data.message;

            // Reload page after 2 seconds to show new data
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            statusMessage.className = 'status-message error';
            statusMessage.textContent = 'Sync failed: ' + data.message;
            btn.disabled = false;
            btn.innerHTML = '<span class="sync-icon">&#x21bb;</span> Refresh Data';
        }
    })
    .catch(error => {
        statusMessage.className = 'status-message error';
        statusMessage.textContent = 'Error: ' + error.message;
        btn.disabled = false;
        btn.innerHTML = '<span class="sync-icon">&#x21bb;</span> Refresh Data';
    });
});

// Modal functions
let currentFirebaseId = null;
let currentDate = null;

function showMessages(firebaseId, date) {
    currentFirebaseId = firebaseId;
    currentDate = date;

    const modal = document.getElementById('message-modal');
    const modalInfo = document.getElementById('message-modal-info');
    const modalMessages = document.getElementById('message-modal-messages');

    modalInfo.innerHTML = '<p>Loading...</p>';
    modalMessages.innerHTML = '';
    modal.style.display = 'block';

    fetch(`/api/messages/${firebaseId}/${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                const dateFormatted = new Date(date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                modalInfo.innerHTML = `
                    <div class="message-info">
                        <p><strong>Firebase ID:</strong> ${user.firebase_id}</p>
                        <p><strong>REDCap ID:</strong> ${user.redcap_id}</p>
                        <p><strong>Identifier:</strong> ${user.identifier}</p>
                        <p><strong>Research Assistant:</strong> ${user.research_assistant}</p>
                        <p><strong>Date:</strong> ${dateFormatted}</p>
                    </div>
                `;

                if (data.messages.length > 0) {
                    let messagesHtml = '<div class="messages-list">';
                    data.messages.forEach(msg => {
                        const riskClass = msg.is_risky ? 'high-risk' : '';
                        const reviewedClass = msg.is_reviewed ? 'reviewed' : 'unreviewed';
                        const riskBadge = msg.is_risky
                            ? `<span class="risk-badge">!</span><span class="risk-score-text">Risky</span>`
                            : '';
                        const reviewedBadge = msg.is_reviewed ? '<span class="reviewed-badge">✓ Reviewed</span>' : '<span class="unreviewed-badge">⚠ Unreviewed</span>';

                        messagesHtml += `
                            <div class="message-item ${riskClass} ${reviewedClass}">
                                <div class="message-header">
                                    <span class="message-time">${msg.timestamp}</span>
                                    ${riskBadge}
                                    ${reviewedBadge}
                                </div>
                                <div class="message-text">${escapeHtml(msg.text)}</div>
                            </div>
                        `;
                    });
                    messagesHtml += '</div>';
                    modalMessages.innerHTML = messagesHtml;
                } else {
                    modalMessages.innerHTML = '<p>No messages found for this date.</p>';
                }
            } else {
                modalInfo.innerHTML = `<p class="error">Error: ${data.message}</p>`;
            }
        })
        .catch(error => {
            modalInfo.innerHTML = `<p class="error">Error loading messages: ${error.message}</p>`;
        });
}

function closeMessageModal() {
    document.getElementById('message-modal').style.display = 'none';
    currentFirebaseId = null;
    currentDate = null;
}

function markDateReviewed() {
    if (!currentFirebaseId || !currentDate) {
        return;
    }

    const btn = document.getElementById('mark-reviewed-btn');
    btn.disabled = true;
    btn.textContent = 'Marking...';

    fetch(`/api/messages/date/${currentFirebaseId}/${currentDate}/mark-reviewed`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeMessageModal();
            // Reload the page to update the dashboard
            location.reload();
        } else {
            alert('Error: ' + data.message);
            btn.disabled = false;
            btn.textContent = 'Mark All as Reviewed';
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Mark All as Reviewed';
    });
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('message-modal');
    if (event.target === modal) {
        closeMessageModal();
    }
}
</script>
{% endblock %}
